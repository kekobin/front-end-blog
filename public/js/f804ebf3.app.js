angular.module("eBlog",["ui.router"]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(a,b,c){a.state("home",{url:"/home","abstract":!0,templateUrl:"/templates/home.html",controller:"HomeController"}).state("home.login",{url:"/login",templateUrl:"/templates/login.html",controller:"LoginController"}).state("home.register",{url:"/register",templateUrl:"/templates/register.html",controller:"RegisterController"}).state("home.articleList",{url:"/articleList",templateUrl:"/templates/articleList.html",controller:"ArticleListController"}).state("home.setting",{url:"/setting",templateUrl:"/templates/setting.html",controller:"SettingController"}).state("home.mypage",{url:"/mypage/:id",templateUrl:"/templates/mypage.html",controller:"MypageController"}).state("home.myarticle",{url:"/myarticle/:id",templateUrl:"/templates/myarticle.html",controller:"MyarticleController"}).state("writer",{url:"/writer/:id",templateUrl:"/templates/writer.html",controller:"WriterController"}).state("manager",{url:"/manager",templateUrl:"/templates/manager.html",controller:"ManagerController"}),b.otherwise("/home/articleList"),c.html5Mode(!0)}]),angular.module("eBlog").controller("MainController",["$rootScope","userService","$http","articleService","$state","$timeout",function(a,b,c,d,e,f){var g=JSON.parse(sessionStorage.getItem("user"));g&&(console.log(g),b.init(g)),a.user=g,a.logout=function(){c.get("/logout").then(function(a){sessionStorage.removeItem("user"),d.clear(),b.clear(),e.go("home.articleList"),f(function(){location.reload()},100)})}}]),angular.module("eBlog").controller("HomeController",["$scope","$state","$http","$timeout",function(a,b,c,d){a.signIn=function(){b.go("login")},a.regist=function(){b.go("register")};var e=$("#userDropDown");$("#userAvatar").on("click",function(a){a.stopPropagation(),e.toggle()}),$(window).on("click",function(){"none"!=e.css("display")&&e.hide()})}]),angular.module("eBlog").controller("LoginController",["$scope","$http","$state","userService","$rootScope",function(a,b,c,d,e){var f=angular.element(document.getElementById("loginForm")),g=angular.element(document.getElementById("errorSign"));f.find("input");a.login=function(){var f=a.username,g=a.password;b.post("/login",{username:f,password:g}).then(function(a){if(a.data&&a.status&&200===a.status){var b={id:a.data._id,name:a.data.username,nickname:a.data.nickname,avatar:a.data.avatar,introduction:a.data.introduction};sessionStorage.setItem("user",JSON.stringify(b)),e.user=b,d.init(b),c.go("home.articleList")}},function(a){console.log("error:"+JSON.stringify(a))})},a.keyup=function(){g.css({display:"none"})}}]),angular.module("eBlog").controller("RegisterController",function(a,b,c){var d=angular.element(document.getElementById("registerForm")),e=angular.element(document.getElementById("errorSign2"));d.find("input");a.register=function(){var d=a.username,e=a.nickname,f=a.password,g=a.password2;g==f&&b.post("/register",{username:d,nickname:e,password:f,introduction:"世界很大，我想去看看!~",avatar:"/img/avatar-default.png"}).then(function(a){console.log("----this is register------"),console.log(a),a.data&&a.status&&200===a.status&&c.go("home.login")},function(a){console.log("error:"+JSON.stringify(a))})},a.keyup=function(){e.css({display:"none"})}}),angular.module("eBlog").controller("ArticleListController",["$scope","$state","$http","userService",function(a,b,c,d){function e(){c.get(g).then(function(b){console.log("----get articles successful----"),console.log(b.data),b.data&&b.status&&200===b.status&&(a.articles=b.data)},function(a){console.log("----get articles successful----"),console.log(a.data)})}function f(a){g="0"==a?"/api/article":"/api/article/t/"+a,e()}var g="/api/article",h=d.get();e(),a.goToDetail=function(){b.go("home.articleDetail")},a.write=function(){h.name?b.go("writer"):b.go("home.login")},$("#sortNav>li").on("click",function(){var a=$(this).attr("data-type");$(this).addClass("active").siblings().removeClass("active"),f(a)}),$("#dropdown>a.first").addClass("active").siblings().removeClass("active")}]),angular.module("eBlog").controller("MypageController",["$scope","$state","$http","userService","$stateParams",function(a,b,c,d,e){function f(){c.get("/api/article/"+g).then(function(b){console.log("----get user articles successful----"),console.log(b.data),b.data&&b.status&&200===b.status&&(a.articles=b.data)},function(a){console.log("----get user articles error----"),console.log(a.data)}),a.user.id==g&&$("#dropdown .third").addClass("active").siblings().removeClass("active")}a.user=d.get();var g=a.id=e.id;f(),a.goDetail=function(a){b.go("home.myarticle",{id:a})}}]),angular.module("eBlog").controller("WriterController",["$scope","$state","$http","userService","$stateParams","articleService","$timeout",function(a,b,c,d,e,f,g){function h(){function d(){var d=$("#navList>li.active").attr("data-type"),f={uid:e.uid,username:e.username,nickname:e.nickname,title:a.title,content:l.getValue(),type:d,time:(new Date).getTime(),pv:e.pv,comment:e.comment};c.put("/api/article/"+e._id,{data:f}).then(function(c){console.log("----successful----"),console.log(c),b.go("home.mypage",{id:a.user.id})},function(a){console.log("----error----"),console.log(a)})}var e=f.get();$("#navList>li[data-type="+e.type+"]").addClass("active").siblings().removeClass("active"),a.title=e.title,$(".simditor-body").html(e.content),a.update=function(){d()}}var i=$("#navList>li.active").attr("data-type"),j=parseInt($(window).height())-22,k=j-154,l=new Simditor({textarea:$("#editor"),upload:{url:"/upload",fileKey:"upfile",connectionCount:1},pasteImage:!0});a.user=d.get(),$(".js-height").height(j),$(".simditor-body").css("height",k),$("#navList>li").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),i=$(this).attr("data-type")}),a.publish=function(){var e={uid:d.getId(),username:d.getName(),nickname:d.getNickname(),title:a.title,content:l.getValue(),type:i,time:(new Date).getTime(),pv:0,comment:[]};console.log(">>>article data>>>>>"+JSON.stringify(e)),c.post("/api/article",{data:e}).then(function(c){console.log("----successful----"),console.log(c),b.go("home.mypage",{id:a.user.id})},function(a){console.log("----error----"),console.log(a)})},a.aid=e.id,a.aid&&h()}]),angular.module("eBlog").controller("MyarticleController",["$scope","$state","$http","$stateParams","userService","articleService","utilService",function(a,b,c,d,e,f,g){function h(a){for(var b,c=(new Date).getTime(),d=(g.formatTime(c),0),e=k.comment.length;e>d;d++){var f=k.comment[d];if(f.cid===a){b=f;break}}return b}function i(){c.get("/api/article/d/"+l).then(function(b){console.log("----get user 1 detail article successful----"),console.log(b.data),b.data&&b.status&&200===b.status&&(k=b.data,a.articleTime=g.formatTime(b.data.time),a.article=b.data,$("#showContent").html(a.article.content))},function(a){console.log("----get user 1 detail article error----"),console.log(a.data)}),$("#dropdown>a.first").addClass("active").siblings().removeClass("active")}function j(){var b={uid:k.uid,username:k.username,nickname:k.nickname,title:k.title,content:k.content,type:k.type,time:k.time,pv:k.pv,comment:k.comment};c.put("/api/article/"+k._id,{data:b}).then(function(b){console.log("----successful----"),console.log(b),a.message=""},function(a){console.log("----error----"),console.log(a)})}var k,l=d.id;a.user=e.getName(),i(),a.modify=function(a){f.set(k),b.go("writer",{id:a})},a["delete"]=function(a){c["delete"]("/api/article/"+a).then(function(a){console.log("----delete article successful----"),console.log(a.data),a.data&&a.status&&200===a.status&&b.go("home.articleList")},function(a){console.log("----delete article successful----"),console.log(a.data)})},a.publish=function(){var b=(new Date).getTime(),c=g.formatTime(b),d={cid:b,cuser:e.get(),tuser:{id:k.uid,name:k.username,nickname:k.nickname},message:a.message,time:c,reply:[]};k.comment.push(d),j()},a.reply=function(b,c){var d=$(c.target).parent().parent().find(".reply-input");d.show(),a.myKeyup=function(a){var c=window.event?a.keyCode:a.which;if(13==c){var d=(new Date).getTime(),f=g.formatTime(d),i=$(a.target),k=h(b),l={rid:d,time:f,user:e.get(),message:i.val()};k.reply.push(l),j(),i.parent().hide(),i.val("")}}},a.deleteComment=function(a){for(var b=0,c=k.comment.length;c>b;b++){var d=k.comment[b];if(d.cid===a){k.comment.splice(b,1),j();break}}},a.deleteReply=function(a,b){for(var c,d=0,e=k.comment.length;e>d;d++){var f=k.comment[d];if(f.cid===a){c=f.reply;break}}if(0!==c.length)for(var d=0,e=c.length;e>d;d++){var f=c[d];if(f.rid===b){c.splice(d,1),j();break}}}}]),angular.module("eBlog").controller("SettingController",["$scope","$state","$http","userService","$rootScope",function(a,b,c,d,e){var f=d.get();a.nickname=f.nickname,a.introduction=f.introduction,a.save=function(){var g={username:f.name,nickname:a.nickname,introduction:a.introduction,avatar:f.avatar,password:a.password};c.post("/api/user/"+f.id,{data:g}).then(function(a){if(a.data&&a.status&&200===a.status){var c={id:f.id,name:f.name,nickname:a.data.nickname,avatar:a.data.avatar,introduction:a.data.introduction};sessionStorage.setItem("user",JSON.stringify(c)),e.user=c,d.init(c),b.go("home.articleList")}},function(a){console.log("---modify setting error--"),console.log(a)})}}]),angular.module("eBlog").controller("ManagerController",["$scope","$state","$http",function(a,b,c){function d(){c.get("/api/user").then(function(b){b.data&&b.status&&200===b.status&&(a.users=b.data)},function(a){console.log("error:"+JSON.stringify(a))})}a.isAdmin=!1;var e=window.prompt("输入账号","");if("kebin"==e){var f=window.prompt("输入密码","");"kebin12345678"==f&&(a.isAdmin=!0,d())}a["delete"]=function(b){c["delete"]("/api/user/"+b).then(function(c){if(c.data&&c.status&&200===c.status)for(var d=0,e=a.users.length;e>d;d++){var f=a.users[d];f._id===b&&a.users.splice(d,1)}},function(a){console.log("error:"+JSON.stringify(a))})},a.addUser=function(){var b=a.username,d=a.nickname,e=a.password;c.post("/register",{username:b,nickname:d,password:e,introduction:"世界很大，我想去看看!~",avatar:"/img/avatar-default.png"}).then(function(a){a.data&&a.status&&200===a.status&&location.reload()},function(a){console.log("error:"+JSON.stringify(a))})}}]),angular.module("eBlog").factory("userService",function(){var a={};return{init:function(b){a=b},get:function(){return a},getId:function(){return a.id},getName:function(){return a.name},getNickname:function(){return a.nickname},clear:function(){a={}}}}),angular.module("eBlog").factory("utilService",function(){return{formatTime:function(a){var b=new Date(parseInt(a));return b.getFullYear()+"."+(b.getMonth()+1)+"."+b.getDate()+" "+b.getHours()+":"+b.getMinutes()}}}),angular.module("eBlog").factory("articleService",function(){var a={};return{set:function(b){a=b},get:function(){return a},clear:function(){a={}}}}),angular.module("eBlog").filter("timeFilter",function(){var a=6e4,b=60*a,c=24*b,d="";return function(e){var f=(new Date).getTime();e=parseInt(e);var g=f-e,h=g/c,i=g/b,j=g/a;return d=h>=20?"20天":h>=1?Math.ceil(h)+"天":i>=1?Math.ceil(i)+"小时":j>=1?Math.ceil(j)+"分钟":"1分钟"}}),angular.module("eBlog").directive("comment",function(){return{scope:{publish:"&",message:"="},restrict:"ECMA",templateUrl:"../../templates/comment.html",replace:!0,link:function(a,b,c){a.pub=function(){a.publish()},a.myKeyup=function(b){var c=window.event?b.keyCode:b.which;13==c&&b.ctrlKey&&a.publish()}}}});